erick@erick:~/labs/devnet-src/ansible/playbooks$ more backup_csr.yml 
---
- name: BACKUP CSR - DEVASC EXAM
  hosts: csr_routers
  gather_facts: no
  vars:
    timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"
    ftp_server: "192.168.35.2"
    backup_dir: "/home/admin/backups"
    backup_local_dir: "./backups"

  tasks:
    - name: 1ï¸âƒ£ Verificar conexiÃ³n al router
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 5
      delegate_to: localhost
      register: connection_check

    - name: 2ï¸âƒ£ Mostrar informaciÃ³n de conexiÃ³n
      debug:
        msg: "âœ… Conectando a {{ inventory_hostname }} ({{ ansible_host }})"

    - name: 3ï¸âƒ£ Obtener hostname del router
      cisco.ios.ios_command:
        commands:
          - show run | include hostname
      register: hostname_output

    - name: 4ï¸âƒ£ Mostrar salida del comando
      debug:
        var: hostname_output

    - name: 5ï¸âƒ£ Extraer hostname
      set_fact:
        router_hostname: "{{ hostname_output.stdout[0] | default('CSR') | regex_replace('hostname ', '') | trim }}"

    - name: 6ï¸âƒ£ Mostrar hostname extraÃ­do
      debug:
        msg: "ğŸ“› Router: {{ router_hostname }}"

    - name: 7ï¸âƒ£ Crear directorio de backups local
      file:
        path: "{{ backup_local_dir }}/{{ router_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: 8ï¸âƒ£ Guardar configuraciÃ³n del router
      cisco.ios.ios_config:
        backup: yes
        backup_options:
          filename: "{{ router_hostname }}_{{ timestamp }}.cfg"
          dir_path: "{{ backup_local_dir }}/{{ router_hostname }}/"
      register: backup_result

    - name: 9ï¸âƒ£ Mostrar resultado del backup
      debug:
        var: backup_result

    - name: ğŸ”Ÿ Verificar que el backup se creÃ³
      stat:
        path: "{{ backup_local_dir }}/{{ router_hostname }}/{{ router_hostname }}_{{ timestamp }}.cfg"
      delegate_to: localhost
      register: backup_file

    - name: 1ï¸âƒ£1ï¸âƒ£ Mostrar informaciÃ³n del archivo
      debug:
        var: backup_file

    - name: 1ï¸âƒ£2ï¸âƒ£ Verificar si el archivo existe
      debug:
        msg: 
          - "Â¿Archivo existe? {{ backup_file.stat.exists if backup_file.stat is defined else 'No definido' }}"
          - "Ruta: {{ backup_local_dir }}/{{ router_hostname }}/{{ router_hostname }}_{{ timestamp }}.cfg"

    - name: 1ï¸âƒ£3ï¸âƒ£ Subir backup al servidor FTP
      shell: |
        curl -T {{ backup_local_dir }}/{{ router_hostname }}/{{ router_hostname }}_{{ timestamp }}.cfg \
          ftp://{{ ftp_server }}{{ backup_dir }}/ \
          --user admin:admin
      register: ftp_upload
      ignore_errors: yes
      delegate_to: localhost
      when: backup_file.stat is defined and backup_file.stat.exists

    - name: 1ï¸âƒ£4ï¸âƒ£ Verificar subida FTP
      debug:
        msg: "âœ… Backup subido al servidor FTP: {{ ftp_server }}"
      when: ftp_upload is defined and ftp_upload is success

    - name: 1ï¸âƒ£5ï¸âƒ£ Crear enlace simbÃ³lico 'latest'
      file:
        src: "{{ router_hostname }}_{{ timestamp }}.cfg"
        dest: "{{ backup_local_dir }}/{{ router_hostname }}/{{ router_hostname }}_latest.cfg"
        state: link
        force: yes
      delegate_to: localhost
      when: backup_file.stat is defined and backup_file.stat.exists

    - name: 1ï¸âƒ£6ï¸âƒ£ Resumen final
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… BACKUP COMPLETADO"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ“ Router: {{ router_hostname }}"
          - "ğŸ“ Backup local: {{ backup_local_dir }}/{{ router_hostname }}/{{ router_hostname }}_{{ timestamp }}.cfg"
          - "ğŸ“¦ TamaÃ±o: {{ backup_file.stat.size if backup_file.stat is defined and backup_file.stat.exists else 'N/A' }} bytes"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
