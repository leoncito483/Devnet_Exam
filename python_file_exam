#!/usr/bin/env python3

import requests
import urllib3
from requests.auth import HTTPBasicAuth
from dnacentersdk import DNACenterAPI

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# DNA Center
DNAC_HOST = "sandboxdnac2.cisco.com"
DNAC_USER = "devnetuser"
DNAC_PASS = "Cisco123!"
DNAC_VERSION = "2.3.5.3"

# CSR Router
CSR_HOST = "192.168.1.100"
CSR_USER = "admin"
CSR_PASS = "admin"

print("Conectando a DNA Center...")
dnac = DNACenterAPI(
    username=DNAC_USER,
    password=DNAC_PASS,
    base_url=f"https://{DNAC_HOST}",
    version=DNAC_VERSION,
    verify=False
)
print("✓ Conectado")

print("Obteniendo dispositivos...")
devices = dnac.devices.get_device_list()

# Verificar si hay dispositivos
if devices.response and len(devices.response) > 0:
    first_device = devices.response[0]
    new_hostname = first_device.hostname
    print(f"Dispositivo encontrado: {new_hostname}")
else:
    print("⚠️ No hay dispositivos en el sandbox. Usando hostname por defecto.")
    new_hostname = "CSR-DEVNET-DEFAULT"

print(f"Configurando CSR con hostname: {new_hostname}")

# RESTCONF
url = f"https://{CSR_HOST}/restconf/data/Cisco-IOS-XE-native:native/hostname"
headers = {
    "Content-Type": "application/yang-data+json",
    "Accept": "application/yang-data+json"
}
payload = {"Cisco-IOS-XE-native:hostname": new_hostname}

response = requests.put(
    url,
    headers=headers,
    auth=HTTPBasicAuth(CSR_USER, CSR_PASS),
    json=payload,
    verify=False,
    timeout=10
)

if response.status_code in [200, 201, 204]:
    print(f"✅ CSR actualizado a: {new_hostname}")
else:
    print(f"❌ Error {response.status_code}")
    print(response.text)
